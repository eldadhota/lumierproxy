<!DOCTYPE html><html><head><title>Lumier Dynamics - Device Monitor</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>` + baseStyles + `.monitor-header{background:#1a1a1a;padding:20px;border-radius:12px;border:1px solid #2a2a2a;margin-bottom:20px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}.device-selector{display:flex;align-items:center;gap:10px;flex:1}.device-selector label{font-weight:600;color:#888}.device-selector select{padding:10px 15px;border:1px solid #2a2a2a;border-radius:8px;font-size:1em;background:#121212;color:#e0e0e0;min-width:300px}.auto-refresh-toggle{display:flex;align-items:center;gap:8px;color:#888}.auto-refresh-toggle input{width:18px;height:18px;cursor:pointer}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}.info-panel{background:#1a1a1a;border-radius:12px;border:1px solid #2a2a2a;padding:20px}.info-panel h3{margin:0 0 15px 0;color:#4a9eff;font-size:1.1em;display:flex;align-items:center;gap:8px}.info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2a2a2a}.info-row:last-child{border-bottom:none}.info-label{color:#888}.info-value{font-weight:600;color:#e0e0e0}.info-value.online{color:#4caf50}.info-value.offline{color:#f44336}.stats-panel{display:grid;grid-template-columns:repeat(3,1fr);gap:15px}.stat-item{background:#121212;padding:15px;border-radius:8px;text-align:center}.stat-number{font-size:1.5em;font-weight:bold;color:#4a9eff}.stat-label{font-size:0.85em;color:#888;margin-top:5px}.activity-panel{background:#1a1a1a;border-radius:12px;border:1px solid #2a2a2a;margin-bottom:20px}.activity-panel h3{margin:0;padding:15px 20px;background:#252525;border-radius:12px 12px 0 0;color:#e0e0e0;font-size:1.1em}.activity-list{max-height:300px;overflow-y:auto}.activity-item{padding:12px 20px;border-bottom:1px solid #2a2a2a;display:grid;grid-template-columns:140px 100px 1fr 60px;gap:15px;align-items:center;font-size:0.9em}.activity-item:nth-child(odd){background:#1e1e1e}.activity-time{color:#888;font-size:0.85em}.activity-action{background:#1a2a3a;color:#4a9eff;padding:3px 8px;border-radius:4px;font-size:0.8em;text-align:center}.activity-details{color:#e0e0e0}.activity-status.success{color:#4caf50}.activity-status.failed{color:#f44336}.connections-panel{background:#1a1a1a;border-radius:12px;border:1px solid #2a2a2a}.connections-panel h3{margin:0;padding:15px 20px;background:#252525;border-radius:12px 12px 0 0;color:#e0e0e0;font-size:1.1em;display:flex;justify-content:space-between;align-items:center}.live-badge{background:#4caf50;color:white;padding:3px 10px;border-radius:12px;font-size:0.75em;animation:pulse 2s infinite}.connections-table{width:100%;border-collapse:collapse}.connections-table th{background:#252525;padding:12px 15px;text-align:left;font-weight:600;color:#888;font-size:0.85em}.connections-table td{padding:12px 15px;border-bottom:1px solid #2a2a2a;font-size:0.9em}.connections-table tr:hover{background:#1e1e1e}.conn-host{color:#4a9eff;font-weight:500}.conn-protocol{background:#1a2a3a;color:#4a9eff;padding:2px 8px;border-radius:4px;font-size:0.8em}.conn-bytes{color:#888}.conn-status.success{color:#4caf50}.conn-status.failed{color:#f44336}.no-device{text-align:center;padding:60px 20px;color:#666}.no-device-icon{font-size:4em;margin-bottom:20px}.connections-scroll{max-height:400px;overflow-y:auto}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}</style></head><body>` + navHTML + `<div class="main-content"><div class="page-header"><h1>üîç Device Monitor</h1><p>Real-time monitoring for individual devices</p></div><div class="monitor-header"><div class="device-selector"><label>Select Device:</label><select id="deviceSelect" onchange="loadDeviceData()"><option value="">-- Choose a device --</option></select></div><label class="auto-refresh-toggle"><input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()"> Auto-refresh (5s)</label><button class="btn btn-secondary" onclick="loadDeviceData()">üîÑ Refresh</button></div><div id="monitorContent"><div class="no-device"><div class="no-device-icon">üì±</div><h2>Select a Device to Monitor</h2><p>Choose a device from the dropdown above to see detailed information, activity logs, and live connections.</p></div></div></div><script>` + baseJS + `document.getElementById('nav-device-monitor').classList.add('active');let allDevices=[];let selectedDevice=null;let refreshInterval=null;function loadDevices(){fetch('/api/ap/devices').then(r=>r.json()).then(devices=>{allDevices=devices||[];const select=document.getElementById('deviceSelect');const currentVal=select.value;select.innerHTML='<option value="">-- Choose a device ('+allDevices.length+' available) --</option>';allDevices.sort((a,b)=>{if(a.confirmed&&!b.confirmed)return -1;if(!a.confirmed&&b.confirmed)return 1;return new Date(b.last_seen)-new Date(a.last_seen);}).forEach(d=>{const name=d.custom_name||d.hostname||'Unknown';const status=isOnline(d)?'‚óè ':'‚óã ';const confirmed=d.confirmed?'':'[Pending] ';select.innerHTML+='<option value="'+d.mac+'">'+status+confirmed+name+' ('+d.ip+')</option>';});if(currentVal)select.value=currentVal;}).catch(()=>{});}function isOnline(d){return(Date.now()-new Date(d.last_seen))/60000<5;}function loadDeviceData(){const mac=document.getElementById('deviceSelect').value;if(!mac){document.getElementById('monitorContent').innerHTML='<div class="no-device"><div class="no-device-icon">üì±</div><h2>Select a Device to Monitor</h2><p>Choose a device from the dropdown above to see detailed information, activity logs, and live connections.</p></div>';selectedDevice=null;return;}selectedDevice=allDevices.find(d=>d.mac===mac);if(!selectedDevice){loadDevices();return;}Promise.all([fetch('/api/device-activity?device_ip='+selectedDevice.ip+'&limit=50').then(r=>r.json()).catch(()=>[]),fetch('/api/device-connections?device_ip='+selectedDevice.ip+'&limit=50').then(r=>r.json()).catch(()=>[])]).then(([activity,connections])=>{renderDeviceMonitor(selectedDevice,activity,connections);});}function renderDeviceMonitor(device,activity,connections){const online=isOnline(device);const lastSeenMins=Math.floor((Date.now()-new Date(device.last_seen))/60000);const firstSeen=new Date(device.first_seen).toLocaleDateString();const proxyName=device.proxy_name||'Proxy #'+(device.proxy_index+1);document.getElementById('monitorContent').innerHTML=`<div class="info-grid"><div class="info-panel"><h3>üì± Device Information</h3><div class="info-row"><span class="info-label">Name</span><span class="info-value">${escapeHtml(device.custom_name||device.hostname||'Unknown')}</span></div><div class="info-row"><span class="info-label">Status</span><span class="info-value ${online?'online':'offline'}">${online?'‚óè Online':'‚óã Offline'}</span></div><div class="info-row"><span class="info-label">IP Address</span><span class="info-value">${device.ip}</span></div><div class="info-row"><span class="info-label">MAC Address</span><span class="info-value" style="font-family:monospace;font-size:0.9em">${device.mac}</span></div><div class="info-row"><span class="info-label">Hostname</span><span class="info-value">${escapeHtml(device.hostname||'-')}</span></div><div class="info-row"><span class="info-label">Group</span><span class="info-value">${escapeHtml(device.group||'Default')}</span></div><div class="info-row"><span class="info-label">Approved</span><span class="info-value" style="color:${device.confirmed?'#4caf50':'#ff9800'}">${device.confirmed?'Yes':'Pending'}</span></div><div class="info-row"><span class="info-label">First Seen</span><span class="info-value">${firstSeen}</span></div><div class="info-row"><span class="info-label">Last Seen</span><span class="info-value">${lastSeenMins<1?'Just now':lastSeenMins+' minutes ago'}</span></div></div><div class="info-panel"><h3>üìä Statistics</h3><div class="stats-panel"><div class="stat-item"><div class="stat-number">${formatNumber(device.request_count||0)}</div><div class="stat-label">Requests</div></div><div class="stat-item"><div class="stat-number" style="color:${(device.error_count||0)>0?'#f44336':'#4caf50'}">${device.error_count||0}</div><div class="stat-label">Errors</div></div><div class="stat-item"><div class="stat-number">${formatBytes(device.bytes_in||0)}</div><div class="stat-label">Downloaded</div></div><div class="stat-item"><div class="stat-number">${formatBytes(device.bytes_out||0)}</div><div class="stat-label">Uploaded</div></div><div class="stat-item"><div class="stat-number">${formatBytes((device.bytes_in||0)+(device.bytes_out||0))}</div><div class="stat-label">Total Traffic</div></div><div class="stat-item"><div class="stat-number" style="font-size:1em">${escapeHtml(proxyName)}</div><div class="stat-label">Assigned Proxy</div></div></div>${device.last_error?`<div style="margin-top:15px;padding:10px;background:#3d1a1a;border-radius:8px;font-size:0.85em"><strong style="color:#f44336">Last Error:</strong> <span style="color:#e0e0e0">${escapeHtml(device.last_error)}</span></div>`:''}</div></div><div class="activity-panel"><h3>üìã Recent Activity</h3><div class="activity-list" id="activityList">${renderActivity(activity)}</div></div><div class="connections-panel"><h3>üîó Live Connections <span class="live-badge">LIVE</span></h3><div class="connections-scroll"><table class="connections-table"><thead><tr><th>Time</th><th>Host</th><th>Protocol</th><th>Downloaded</th><th>Uploaded</th><th>Status</th></tr></thead><tbody id="connectionsList">${renderConnections(connections)}</tbody></table></div></div>`;}function renderActivity(activity){if(!activity||!activity.length){return '<div style="padding:20px;text-align:center;color:#666">No recent activity recorded</div>';}return activity.slice(0,30).map(a=>{const time=new Date(a.timestamp).toLocaleTimeString();return`<div class="activity-item"><span class="activity-time">${time}</span><span class="activity-action">${escapeHtml(a.action||'activity')}</span><span class="activity-details">${escapeHtml(a.details||a.target_host||'-')}</span><span class="activity-status ${a.success?'success':'failed'}">${a.success?'‚úì':'‚úó'}</span></div>`;}).join('');}function renderConnections(connections){if(!connections||!connections.length){return '<tr><td colspan="6" style="text-align:center;color:#666;padding:20px">No recent connections</td></tr>';}return connections.slice(0,50).map(c=>{const time=new Date(c.timestamp).toLocaleTimeString();return`<tr><td>${time}</td><td class="conn-host">${escapeHtml(c.host||'-')}</td><td><span class="conn-protocol">${c.protocol||'TCP'}</span></td><td class="conn-bytes">${formatBytes(c.bytes_in||0)}</td><td class="conn-bytes">${formatBytes(c.bytes_out||0)}</td><td class="conn-status ${c.success?'success':'failed'}">${c.success?'‚úì OK':'‚úó Failed'}</td></tr>`;}).join('');}function toggleAutoRefresh(){if(document.getElementById('autoRefresh').checked){startAutoRefresh();}else{stopAutoRefresh();}}function startAutoRefresh(){stopAutoRefresh();refreshInterval=setInterval(()=>{if(selectedDevice)loadDeviceData();},5000);}function stopAutoRefresh(){if(refreshInterval){clearInterval(refreshInterval);refreshInterval=null;}}function escapeHtml(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}loadDevices();startAutoRefresh();setInterval(loadDevices,30000);</script></body></html>
