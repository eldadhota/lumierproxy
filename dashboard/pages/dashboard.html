<!DOCTYPE html><html><head><title>Lumier Dynamics - Devices</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>` + baseStyles + `.toolbar{background:#1a1a1a;padding:15px 20px;border-radius:12px;margin-bottom:20px;border:1px solid #2a2a2a;display:flex;flex-wrap:wrap;gap:15px;align-items:center}.search-box{flex:1;min-width:200px;position:relative}.search-box input{width:100%;padding:10px 15px 10px 40px;border:1px solid #2a2a2a;border-radius:8px;font-size:1em;background:#121212;color:#e0e0e0}.search-box input:focus{outline:none;border-color:#4a9eff}.search-box::before{content:"üîç";position:absolute;left:12px;top:50%;transform:translateY(-50%)}.filter-group{display:flex;gap:10px;align-items:center}.filter-group label{font-weight:600;color:#888;font-size:0.9em}.filter-group select{padding:8px 12px;border:1px solid #2a2a2a;border-radius:8px;background:#121212;color:#e0e0e0}.device-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}.device-card{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;padding:18px;transition:all 0.2s;position:relative}.device-card:hover{border-color:#4a9eff}.device-card.selected{border-color:#4a9eff;background:#1e2a3a}.device-card.pending-ap{border-color:#ff9800;background:#2a2010}.device-card.ap-device{border-left:4px solid #4a9eff}.device-checkbox{position:absolute;top:15px;right:15px;width:20px;height:20px;cursor:pointer}.device-name{font-size:1.15em;font-weight:bold;color:#e0e0e0;margin-bottom:5px;padding-right:30px;cursor:pointer}.device-name:hover{color:#4a9eff}.device-group{display:inline-block;background:#1a3d1a;color:#4caf50;padding:3px 10px;border-radius:12px;font-size:0.8em;font-weight:600;margin-bottom:10px}.device-type-badge{display:inline-block;padding:3px 8px;border-radius:10px;font-size:0.75em;font-weight:600;margin-left:8px}.type-ap{background:#1a2a3a;color:#4a9eff}.type-legacy{background:#2a1a3a;color:#9c7aff}.device-info{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.9em}.info-row{display:flex;justify-content:space-between;padding:3px 0}.info-label{color:#666}.status-badge{padding:3px 10px;border-radius:12px;font-size:0.85em;font-weight:600}.status-active{background:#1a3d1a;color:#4caf50}.status-inactive{background:#3d1a1a;color:#f44336}.status-pending{background:#3d2a1a;color:#ff9800}.proxy-selector{margin-top:12px;padding-top:12px;border-top:1px solid #2a2a2a;grid-column:1/-1}.proxy-selector label{display:block;font-size:0.85em;color:#888;margin-bottom:6px}.proxy-selector select{width:100%;padding:8px;border:1px solid #2a2a2a;border-radius:6px;margin-bottom:8px;background:#121212;color:#e0e0e0}.current-proxy{font-size:0.85em;color:#4a9eff;font-weight:600}.change-btn{width:100%;padding:8px;background:#4a9eff;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600}.change-btn:hover{background:#3a8eef}.approve-btn{background:#4caf50;margin-bottom:8px}.approve-btn:hover{background:#43a047}.pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px}.pagination button{padding:8px 16px;border:1px solid #2a2a2a;background:#1a1a1a;color:#e0e0e0;border-radius:6px;cursor:pointer;font-weight:600}.pagination button:hover:not(:disabled){border-color:#4a9eff;color:#4a9eff}.pagination button:disabled{opacity:0.5;cursor:not-allowed}.bulk-actions{display:flex;gap:10px;align-items:center}.selected-count{background:#4a9eff;color:white;padding:5px 12px;border-radius:20px;font-size:0.85em;font-weight:600}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}.modal{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:15px;padding:25px;width:90%;max-width:450px}.modal h3{margin-bottom:20px;color:#e0e0e0}.modal-field{margin-bottom:15px}.modal-field label{display:block;font-weight:600;color:#888;margin-bottom:5px}.modal-field input,.modal-field select,.modal-field textarea{width:100%;padding:10px;border:1px solid #2a2a2a;border-radius:8px;font-size:1em;background:#121212;color:#e0e0e0}.modal-field textarea{resize:vertical;min-height:80px}.modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}.setup-box{background:#1a2a3a;padding:12px 20px;border-radius:10px;margin-bottom:20px;border-left:4px solid #4a9eff}.setup-box code{background:#121212;padding:2px 6px;border-radius:4px;font-family:monospace;color:#4a9eff;font-weight:bold}</style></head><body>` + navHTML + `<div class="main-content"><div class="page-header"><h1>üì± Device Management</h1><p>Monitor and manage all connected devices (AP + Legacy)</p></div><div class="setup-box">üì° <strong>AP Network:</strong> Connect to the WiFi access point. New devices appear as "Pending" and require approval.<br>üì± <strong>Manual Setup:</strong> Wi-Fi ‚Üí Proxy Manual ‚Üí Host: <code id="serverIP">...</code> Port: <code>8888</code> Username: <code>your-device-name</code></div><div class="stats-grid"><div class="stat-card" onclick="filterByStatus('all')"><div class="stat-value" id="totalDevices">-</div><div class="stat-label">Total</div></div><div class="stat-card" onclick="filterByStatus('pending')"><div class="stat-value" id="pendingDevices" style="color:#ff9800">-</div><div class="stat-label">Pending</div></div><div class="stat-card" onclick="filterByStatus('active')"><div class="stat-value" id="activeDevices">-</div><div class="stat-label">Active</div></div><div class="stat-card" onclick="filterByStatus('inactive')"><div class="stat-value" id="inactiveDevices">-</div><div class="stat-label">Inactive</div></div><div class="stat-card"><div class="stat-value" id="totalProxies">-</div><div class="stat-label">Proxies</div></div><div class="stat-card"><div class="stat-value" id="totalRequests">-</div><div class="stat-label">Requests</div></div></div><div class="toolbar"><div class="search-box"><input type="text" id="searchInput" placeholder="Search devices..." oninput="applyFilters()"></div><div class="filter-group"><label>Type:</label><select id="typeFilter" onchange="applyFilters()"><option value="">All</option><option value="ap">AP Devices</option><option value="legacy">Legacy</option><option value="pending">Pending Approval</option></select></div><div class="filter-group"><label>Group:</label><select id="groupFilter" onchange="applyFilters()"><option value="">All</option></select></div><div class="filter-group"><label>Sort:</label><select id="sortBy" onchange="applyFilters()"><option value="name">Name</option><option value="ip">IP</option><option value="lastSeen" selected>Last Seen</option><option value="requests">Requests</option></select></div><div class="filter-group"><label><input type="checkbox" id="showOffline" onchange="loadData()" style="margin-right:5px">Show Offline</label></div><button class="btn btn-secondary" onclick="loadData()">üîÑ Refresh</button><button class="btn btn-secondary" onclick="location.href='/api/export'">üì§ Export</button><div class="bulk-actions" id="bulkActions" style="display:none"><span class="selected-count"><span id="selectedCount">0</span> selected</span><select id="bulkProxySelect"></select><button class="btn btn-primary" onclick="bulkChangeProxy()">Change</button><button class="btn btn-secondary" onclick="clearSelection()">Clear</button></div></div><div class="card"><h2>Connected Devices</h2><div id="devicesList" class="device-grid"><div class="loading">Loading...</div></div><div class="pagination" id="pagination"></div></div></div><div class="modal-overlay" id="editModal" style="display:none"><div class="modal"><h3>‚úèÔ∏è Edit Device</h3><div class="modal-field"><label>Username (Device ID)</label><input type="text" id="editUsername" placeholder="e.g., phone1, samsung-s23"></div><div class="modal-field"><label>Custom Name</label><input type="text" id="editName" placeholder="e.g., Samsung S23"></div><div class="modal-field"><label>Group</label><select id="editGroup"></select></div><div class="modal-field"><label>Notes</label><textarea id="editNotes" placeholder="Optional notes..."></textarea></div><input type="hidden" id="editDeviceIP"><input type="hidden" id="editDeviceType"><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeviceEdit()">Save</button></div></div></div><div class="modal-overlay" id="approveModal" style="display:none"><div class="modal"><h3>‚úì Approve Device</h3><p style="color:#666;margin-bottom:20px">This device is waiting for approval. Set a name and assign a proxy to grant internet access.</p><div class="modal-field"><label>Device Name</label><input type="text" id="approveName" placeholder="e.g., John's iPhone"></div><div class="modal-field"><label>Assign Proxy</label><select id="approveProxy"></select></div><div class="modal-field"><label>Group</label><select id="approveGroup"></select></div><input type="hidden" id="approveMAC"><div class="modal-buttons"><button class="btn btn-secondary" onclick="closeApproveModal()">Cancel</button><button class="btn btn-primary" style="background:#4caf50" onclick="confirmApprove()">‚úì Approve & Grant Access</button></div></div></div><script>` + baseJS + `document.getElementById('nav-dashboard').classList.add('active');fetch("/api/server-ip").then(r=>r.text()).then(ip=>document.getElementById("serverIP").textContent=ip);let allDevices=[],allProxies=[],allGroups=[],filteredDevices=[],selectedDevices=new Set(),currentPage=1,statusFilter='all';const PER_PAGE=20;function getDisplayName(d){return d.custom_name||d.name||d.hostname||'Unknown';}function isActive(d){return(Date.now()-new Date(d.last_seen))/60000<5;}function proxyLabel(p,i){let ip=p.user&&p.user.includes('ip-')?p.user.split('ip-')[1]:'unknown';return'#'+(i+1)+' ‚Äì '+ip;}function filterByStatus(s){statusFilter=s;if(s==='pending')document.getElementById('typeFilter').value='pending';applyFilters();}function applyFilters(){const search=document.getElementById('searchInput').value.toLowerCase();const group=document.getElementById('groupFilter').value;const type=document.getElementById('typeFilter').value;const sort=document.getElementById('sortBy').value;filteredDevices=allDevices.filter(d=>{if(statusFilter==='pending'&&!(d.device_type==='ap'&&!d.confirmed))return false;if(statusFilter==='active'&&!isActive(d))return false;if(statusFilter==='inactive'&&isActive(d))return false;if(type==='ap'&&d.device_type!=='ap')return false;if(type==='legacy'&&d.device_type!=='legacy')return false;if(type==='pending'&&!(d.device_type==='ap'&&!d.confirmed))return false;if(group&&d.group!==group)return false;if(search&&!getDisplayName(d).toLowerCase().includes(search)&&!d.ip.includes(search)&&!(d.username&&d.username.toLowerCase().includes(search))&&!(d.mac&&d.mac.toLowerCase().includes(search)))return false;return true;});filteredDevices.sort((a,b)=>{const aPending=a.device_type==='ap'&&!a.confirmed;const bPending=b.device_type==='ap'&&!b.confirmed;if(aPending&&!bPending)return -1;if(!aPending&&bPending)return 1;if(sort==='name')return getDisplayName(a).localeCompare(getDisplayName(b));if(sort==='ip')return a.ip.localeCompare(b.ip);if(sort==='lastSeen')return new Date(b.last_seen)-new Date(a.last_seen);if(sort==='requests')return(b.request_count||0)-(a.request_count||0);return 0;});currentPage=1;renderDevices();}function renderDevices(){const c=document.getElementById('devicesList');if(!filteredDevices.length){c.innerHTML='<div class="loading">No devices found</div>';document.getElementById('pagination').innerHTML='';return;}const pages=Math.ceil(filteredDevices.length/PER_PAGE);const start=(currentPage-1)*PER_PAGE;const pageDevices=filteredDevices.slice(start,start+PER_PAGE);c.innerHTML=pageDevices.map(d=>{const mins=Math.floor((Date.now()-new Date(d.last_seen))/60000);const active=mins<5;const sel=selectedDevices.has(d.ip);const isAP=d.device_type==='ap';const isPending=isAP&&!d.confirmed;const pIdx=isAP?d.proxy_index:allProxies.findIndex(p=>p.full===d.upstream_proxy);const opts=allProxies.map((p,i)=>'<option value="'+i+'" '+(i===pIdx?'selected':'')+'>'+proxyLabel(p,i)+'</option>').join('');const pLabel=pIdx>=0?proxyLabel(allProxies[pIdx],pIdx):'N/A';const cardClass='device-card'+(sel?' selected':'')+(isPending?' pending-ap':'')+(isAP?' ap-device':'');const typeBadge=isAP?'<span class="device-type-badge type-ap">üì° AP</span>':'<span class="device-type-badge type-legacy">üì± Legacy</span>';const statusClass=isPending?'status-pending':(active?'status-active':'status-inactive');const statusText=isPending?'‚è≥ Pending':(active?'‚óè Active':'‚óã Inactive');const userDisplay=isAP?(d.mac||''):(d.username||'<em>anonymous</em>');return'<div class="'+cardClass+'"><input type="checkbox" class="device-checkbox" '+(sel?'checked':'')+' onchange="toggleSel(\''+d.ip+'\',this.checked)"><div class="device-name" onclick="'+(isPending?'openApproveModal':'openEditModal')+'(\''+escapeHtml(isAP?d.mac:d.ip)+'\',\''+d.device_type+'\')">'+escapeHtml(getDisplayName(d))+' '+(isPending?'':'‚úèÔ∏è')+'</div>'+typeBadge+'<div class="device-group">'+escapeHtml(d.group||'Default')+'</div><div class="device-info"><div class="info-row"><span class="info-label">Status:</span><span class="status-badge '+statusClass+'">'+statusText+'</span></div><div class="info-row"><span class="info-label">IP:</span><span><strong>'+d.ip+'</strong></span></div><div class="info-row"><span class="info-label">'+(isAP?'MAC':'User')+':</span><span style="font-weight:600;color:#4a9eff;font-size:0.85em">'+userDisplay+'</span></div><div class="info-row"><span class="info-label">Requests:</span><span>'+formatNumber(d.request_count)+'</span></div><div class="info-row"><span class="info-label">Errors:</span><span style="color:'+(d.error_count>0?'#c62828':'#666')+'">'+(d.error_count||0)+'</span></div><div class="info-row"><span class="info-label">Data:</span><span>‚Üì'+formatBytes(d.bytes_in)+'</span></div><div class="info-row"><span class="info-label">Last seen:</span><span>'+(mins<1?'Now':mins+' min')+'</span></div><div class="proxy-selector">'+(isPending?'<button class="change-btn approve-btn" onclick="openApproveModal(\''+escapeHtml(d.mac)+'\',\'ap\')">‚úì Approve Device</button>':'<label>Proxy: <span class="current-proxy">'+pLabel+'</span></label><select id="proxy-'+(isAP?d.mac.replace(/:/g,''):d.ip)+'">'+opts+'</select><button class="change-btn" onclick="changeProxy(\''+escapeHtml(isAP?d.mac:d.ip)+'\',\''+d.device_type+'\')">Change Proxy</button>')+'<button class="change-btn" style="background:#ef5350;margin-top:8px" onclick="deleteDevice(\''+escapeHtml(isAP?d.mac:d.ip)+'\',\''+escapeHtml(isAP?'':d.username||'')+'\',\''+d.device_type+'\')">Delete Device</button></div></div></div>';}).join('');const pag=document.getElementById('pagination');pag.innerHTML=pages>1?'<button onclick="goPage('+(currentPage-1)+')" '+(currentPage===1?'disabled':'')+'>‚Üê Prev</button><span>Page '+currentPage+' of '+pages+'</span><button onclick="goPage('+(currentPage+1)+')" '+(currentPage===pages?'disabled':'')+'>Next ‚Üí</button>':'<span>'+filteredDevices.length+' devices</span>';updateBulk();}function goPage(p){const pages=Math.ceil(filteredDevices.length/PER_PAGE);if(p>=1&&p<=pages){currentPage=p;renderDevices();}}function escapeHtml(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}function toggleSel(ip,checked){checked?selectedDevices.add(ip):selectedDevices.delete(ip);updateBulk();renderDevices();}function clearSelection(){selectedDevices.clear();updateBulk();renderDevices();}function updateBulk(){const b=document.getElementById('bulkActions');b.style.display=selectedDevices.size>0?'flex':'none';document.getElementById('selectedCount').textContent=selectedDevices.size;}function changeProxy(id,type){const selId=type==='ap'?'proxy-'+id.replace(/:/g,''):'proxy-'+id;const idx=parseInt(document.getElementById(selId).value);if(type==='ap'){fetch('/api/ap/device/proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:id,proxy_index:idx})}).then(r=>r.json()).then(d=>{if(d.success){showToast('Proxy changed','success');loadData();}});}else{fetch('/api/change-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({device_ip:id,proxy_index:idx})}).then(r=>r.json()).then(d=>{if(d.ok){showToast('Proxy changed','success');loadData();}});}}function bulkChangeProxy(){const idx=parseInt(document.getElementById('bulkProxySelect').value);fetch('/api/bulk-change-proxy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({device_ips:Array.from(selectedDevices),proxy_index:idx})}).then(r=>r.json()).then(d=>{if(d.ok){showToast(d.updated+' devices updated','success');selectedDevices.clear();loadData();}});}function openEditModal(id,type){const d=allDevices.find(x=>type==='ap'?x.mac===id:x.ip===id);if(!d)return;document.getElementById('editDeviceIP').value=id;document.getElementById('editDeviceType').value=type;document.getElementById('editUsername').value=type==='ap'?d.mac:(d.username||'');document.getElementById('editName').value=d.custom_name||'';document.getElementById('editNotes').value=d.notes||'';document.getElementById('editGroup').innerHTML=allGroups.map(g=>'<option value="'+g+'" '+(g===d.group?'selected':'')+'>'+g+'</option>').join('');document.getElementById('editModal').style.display='flex';}function closeEditModal(){document.getElementById('editModal').style.display='none';}function saveDeviceEdit(){const id=document.getElementById('editDeviceIP').value;const type=document.getElementById('editDeviceType').value;if(type==='ap'){fetch('/api/ap/device/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:id,custom_name:document.getElementById('editName').value,group:document.getElementById('editGroup').value,notes:document.getElementById('editNotes').value})}).then(r=>r.json()).then(d=>{if(d.success){showToast('Device updated','success');closeEditModal();loadData();}});}else{fetch('/api/update-device',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({device_ip:id,username:document.getElementById('editUsername').value,custom_name:document.getElementById('editName').value,group:document.getElementById('editGroup').value,notes:document.getElementById('editNotes').value})}).then(r=>r.json()).then(d=>{if(d.ok){showToast('Device updated','success');closeEditModal();loadData();}});}}function openApproveModal(mac){const d=allDevices.find(x=>x.mac===mac);if(!d)return;document.getElementById('approveMAC').value=mac;document.getElementById('approveName').value=d.hostname||'';document.getElementById('approveProxy').innerHTML=allProxies.map((p,i)=>'<option value="'+i+'">'+proxyLabel(p,i)+'</option>').join('');document.getElementById('approveGroup').innerHTML=allGroups.map(g=>'<option value="'+g+'">'+g+'</option>').join('');document.getElementById('approveModal').style.display='flex';}function closeApproveModal(){document.getElementById('approveModal').style.display='none';}function confirmApprove(){const mac=document.getElementById('approveMAC').value;const name=document.getElementById('approveName').value;const proxyIdx=parseInt(document.getElementById('approveProxy').value);const group=document.getElementById('approveGroup').value;fetch('/api/ap/device/confirm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:mac,confirmed:true,custom_name:name,proxy_index:proxyIdx,group:group})}).then(r=>r.json()).then(d=>{if(d.success){showToast('Device approved! Internet access granted.','success');closeApproveModal();loadData();}else{showToast('Failed to approve: '+(d.error||'Unknown error'),'error');}});}function loadGroups(){return fetch('/api/groups').then(r=>r.json()).then(g=>{allGroups=g;document.getElementById('groupFilter').innerHTML='<option value="">All</option>'+g.map(x=>'<option value="'+x+'">'+x+'</option>').join('');});}function loadData(){const showOffline=document.getElementById('showOffline').checked;Promise.all([fetch('/api/stats').then(r=>r.json()),fetch('/api/devices'+(showOffline?'?include_offline=true':'')).then(r=>r.json()),fetch('/api/proxies').then(r=>r.json()),fetch('/api/ap/devices').then(r=>r.json()).catch(()=>[]),loadGroups()]).then(([stats,devices,proxies,apDevices])=>{const pendingAP=(apDevices||[]).filter(d=>!d.confirmed).length;const totalAP=(apDevices||[]).length;document.getElementById('totalDevices').textContent=(stats.total_devices||0)+totalAP;document.getElementById('pendingDevices').textContent=pendingAP;document.getElementById('activeDevices').textContent=stats.active_devices||0;document.getElementById('inactiveDevices').textContent=(stats.total_devices-stats.active_devices)||0;document.getElementById('totalProxies').textContent=stats.total_proxies||0;document.getElementById('totalRequests').textContent=formatNumber(stats.total_requests||0);const legacyDevices=(devices||[]).map(d=>({...d,device_type:'legacy'}));const apMapped=(apDevices||[]).map(d=>({ip:d.ip,mac:d.mac,hostname:d.hostname,name:d.hostname||'Unknown Device',custom_name:d.custom_name||'',group:d.group||'AP',upstream_proxy:d.upstream_proxy,status:d.status,first_seen:d.first_seen,last_seen:d.last_seen,request_count:d.request_count||0,bytes_in:d.bytes_in||0,bytes_out:d.bytes_out||0,notes:d.notes||'',error_count:d.error_count||0,confirmed:d.confirmed,proxy_index:d.proxy_index,device_type:'ap'}));allDevices=[...legacyDevices,...apMapped];allProxies=proxies||[];document.getElementById('bulkProxySelect').innerHTML=allProxies.map((p,i)=>'<option value="'+i+'">'+proxyLabel(p,i)+'</option>').join('');applyFilters();});}function deleteDevice(id,username,type){const name=username||id;if(!confirm('Delete device "'+name+'"? This will remove all saved settings.')){return;}if(type==='ap'){fetch('/api/ap/device/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mac:id})}).then(r=>r.json()).then(d=>{if(d.success){showToast('Device deleted','success');loadData();}});}else{fetch('/api/delete-device',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({device_ip:id,username:username})}).then(r=>{if(r.ok)return r.json();throw new Error('Failed');}).then(d=>{if(d.ok){showToast('Device deleted','success');loadData();}}).catch(()=>showToast('Failed to delete device','error'));}}loadData();setInterval(loadData,15000);</script></body></html>